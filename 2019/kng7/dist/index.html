<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-type" content="text/html; charset=utf-8"><meta name="theme-color" content="#3498db"><meta name="viewport" content="width=device-width,initial-scale=1"><title>slide</title><meta property="og:title" content="slide"><meta property="og:type" content="article"><link href="vendor.6.5e1e92922b426fbdb4ed.css" rel="stylesheet"><link href="main.3.c06460d473b5566ee112.css" rel="stylesheet"></head><body><div id="root"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="btn-sidebar" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg><article id="webslides"><section class="aligncenter title"><h2>気軽な Node.js バックエンド開発には TypeORM がちょうどいい</h2><p>2019.08.02 #kng7 / LINE株式会社 UIT室 花谷拓磨(@potato4d)</p></section><section class="aligncenter"><h2>自己紹介</h2><ul><li>花谷拓磨(@potato4d)</li><li>Working at...<ul><li>LINE株式会社 UIT室 / Developer Relations室</li></ul></li><li>今日は東京から来ました<ul><li>昨日は <a href="https://serverless.connpass.com/event/137122/">Serverless Meetup Osaka #5</a> で<br>フル Firebase Functions アプリを Firestore へと移行した記録の話をしてきました</li></ul></li></ul></section><section class="aligncenter"><h2>Agenda</h2><ul><li>結局俺たちは O/R Mapper に何を求めているのか</li><li>TypeScript ベースで「ちょうどいい」 TypeORM の紹介</li><li>TypeORM の活用シチュエーション</li></ul></section><section class="aligncenter"><h2>みなさん ORM は好きですか？</h2></section><section class="aligncenter"><h2>何が便利で何が不便ですか？</h2></section><section class="aligncenter"><h2>実はみなさんの言う問題点って<br>「ActiveRecord かどうかが排他なこと」<br>に起因していませんか？</h2></section><section class="aligncenter detail"><h2>結局俺たちは O/R Mapper に何を求めているのか</h2><h3>1. ORM を使うなら ActiveRecord で雑に作りたい</h3><ul><li>開発初期はデータ構造やリレーションにドラスティックな変更が入りやすい<ul><li>できれば高速に対処したい</li></ul></li><li>初期の CRUD くらいは爆速で作ってしまいたい<ul><li>プロトタイピングの速度は落としたくない</li></ul></li></ul></section><section class="aligncenter detail"><h2>結局俺たちは O/R Mapper に何を求めているのか</h2><h3>2. ActiveRecord で作ったものをメンテし続けたくない</h3><ul><li>とはいえ継続的に Model = DB みたいな状態で運用したくない<ul><li>この辺りが年季の入った Rails が嫌われやすい点な気がする</li></ul></li><li>段階的に Repository パターンを適用できるような世界観が欲しい<ul><li>DAO を DAO として用意した上でより抽象度の高い実装に落とし込みたい</li><li>はじめからやると早すぎる最適化感があるので折を見て調整したい</li></ul></li></ul></section><section class="aligncenter detail"><h2>結局俺たちは O/R Mapper に何を求めているのか</h2><h3>3. 可能な限り力の入れ加減をコントロールしたい</h3><ul><li>ゼロベースで何かを作っていく段階<ul><li>多少密結合でも生産性を高めたい</li><li>アプリケーションコードから柔軟に DB の設計に手を入れられると良い</li></ul></li><li>継続的にメンテナンスしていく段階<ul><li>アプリケーション側のエンティティのスキーマ定義もかっちりしたい</li><li>ドメイン上の概念とデータベースアクセスはある程度疎結合にしたい</li><li>Node.js の ORM はマイグレーション弱めだけどしっかり管理したい</li><li>etc..</li></ul></li></ul></section><section class="aligncenter"><h2>そんなものなくない？</h2></section><section class="aligncenter"><h2><img src="https://raw.githubusercontent.com/typeorm/typeorm/master/resources/logo_big.png"></h2></section><section class="aligncenter"><h2>TypeScript ベースで「ちょうどいい」 TypeORM の紹介</h2></section><section class="aligncenter detail"><h2>TypeORM の特徴</h2><ul><li>TypeScript 向けの ORM (JavaScript 対応)<ul><li>MySQL, PostgreSQL, SQLite から MongoDB まで対応</li></ul></li><li>GitHub Star も 15k+ と注目度の高い ORM<ul><li><a href="https://github.com/typeorm/typeorm">https://github.com/typeorm/typeorm</a></li><li>ちなみに NPM の weekly downloads は 100k+</li></ul></li></ul></section><section class="aligncenter detail"><h2>TypeORM の特徴</h2><ol><li>デコレータベースの簡潔かつ TypeSafe なエンティティ定義</li><li>柔軟かつ便利な Migration</li><li>ActiveRecord と Repository にどちらも対応</li></ol></section><section class="aligncenter detail"><h2>TypeORM のうれしいところ</h2><ul><li>デコレータベースの簡潔かつ TypeSafe なエンティティ定義<ul><li><code>@Entity</code> から始まってクラスに対してデコレータで情報を付与していくだけ</li><li>勿論 TypeScript 自体の型の定義と相互作用があり、メタデータによって型定義ベースでの動作指定が可能</li><li><code>@Column</code> のオプションも全て型がついている<ul><li>それもそのはず TypeORM は全て TypeScript で記述されている</li></ul></li></ul></li></ul></section><section class="aligncenter detail"><h2>TypeORM のうれしいところ</h2><pre><code class="language-ts">import {Entity, PrimaryGeneratedColumn, Column, BaseEntity} from &quot;typeorm&quot;;

@Entity()
export class User extends BaseEntity {

    @PrimaryGeneratedColumn()
    id: number;

    @Column()
    firstName: string;

    @Column()
    lastName: string;

    @Column()
    age: number;

}
</code></pre></section><section class="aligncenter detail"><h2>TypeORM のうれしいところ</h2><ul><li>柔軟かつ便利な Migration<ul><li>自動マイグレーションと手動マイグレーションの 2 つのモードが有る</li><li>自動マイグレーションは開発時に便利<ul><li><code>@Entity</code> の定義と DB の差分をみて自動でマイグレーション</li><li>設計と実装にブレがあった場合に実装側で試行錯誤しやすい</li><li>初期の開発において悩みどころが少ない、多少古い情報を共有されても実行時でなんとかなる</li></ul></li><li>手動マイグレーションは完成品のコードとして便利<ul><li>TypeORM の CLI にはマイグレーションのコマンドが一通り揃っている</li><li>マージする時は必ずマイグレーションファイルに落とし込んで適用みたいに柔軟な形に落とし込みやすい</li></ul></li></ul></li></ul></section><section class="aligncenter"><h2>Use manual migration</h2><pre><code class="language-bash">$ typeorm migration:generate -n PostRefactoring # Create migration file
$ typeorm migration:run # Execute migration
$ typeorm migration:revert # Revert migration
</code></pre></section><section class="aligncenter"><h2>Use automatic migration</h2><pre><code class="language-bash">$ yarn dev
yarn run v1.15.2
warning package.json: No license field
$ ts-node src/server.ts
Listen on http://0.0.0.0:8000
query: START TRANSACTION
query: SELECT DATABASE() AS `db_name`
query: SELECT * FROM `INFORMATION_SCHEMA`.`TABLES` WHERE (`TABLE_SCHEMA` = &#x27;podcast&#x27; OR (`TABLE_SCHEMA` = &#x27;podcast&#x27; AND `TABLE_NAME` = &#x27;casts&#x27;) OR (`TABLE_SCHEMA` = &#x27;podcast&#x27; ) OR (`TABLE_SCHEMA` = &#x27;podcast&#x27; AND `TABLE_NAME` = &#x27;pageviews&#x27;) OR (`TABLE_SCHEMA` = &#x27;podcast&#x27; AND `TABLE_NAME` = &#x27;episodes&#x27;) OR (`TABLE_SCHEMA` = &#x27;podcast&#x27; AND `TABLE_NAME` = &#x27;episodes_casts_casts&#x27;)
query: SELECT * FROM `INFORMATION_SCHEMA`.`COLUMNS` WHERE (`TABLE_SCHEMA` = &#x27;podcast&#x27; OR (`TABLE_SCHEMA` = &#x27;podcast&#x27; AND `TABLE_NAME` = &#x27;casts&#x27;) OR (`TABLE_SCHEMA` = &#x27;podcast&#x27; ) OR (`TABLE_SCHEMA` = &#x27;podcast&#x27; AND `TABLE_NAME` = &#x27;pageviews&#x27;) OR (`TABLE_SCHEMA` = &#x27;podcast&#x27; AND `TABLE_NAME` = &#x27;episodes&#x27;) OR (`TABLE_SCHEMA` = &#x27;podcast&#x27; AND `TABLE_NAME` = &#x27;episodes_casts_casts&#x27;)
</code></pre></section><section class="aligncenter detail"><h2>TypeORM のうれしいところ</h2><ul><li>ActiveRecord と Repository にどちらも対応<ul><li>先程述べた「ActiveRecordメンテしたくない問題」を解消できる</li><li>一方で早すぎる最適化が起こるわけでもなく、柔軟に対応しやすい</li></ul></li></ul></section><section class="aligncenter"><h2>TypeORM の活用シチュエーション</h2></section><section class="aligncenter"><h2><img width="800" src="https://user-images.githubusercontent.com/6993514/62269676-b655f680-b46e-11e9-89a6-55d04e26c671.png"></h2><h5>3 月に立ち上げた Podcast サイトで使ってます</h5><p class="text-center"><br><a href="https://uit-inside.linecorp.com/">https://uit-inside.linecorp.com/</a></p></section><section class="aligncenter detail"><h2>TypeORM の活用シチュエーション</h2><ul><li>すみません！あんまりUIT室内では使ってません。<ul><li>Node.js バックエンドの仕事がある現場だと重宝します</li></ul></li></ul></section><section class="aligncenter detail"><h2>TypeORM の活用シチュエーション</h2><ul><li>LINE UIT室の場合<ul><li>Podcast UIT INSIDE の API サーバーで使っています</li></ul></li><li>UIT INSIDE の立ち上げ時の場合<ul><li>とりあえずクリティカルではないのでサクッと立ち上げたい<ul><li>とはいえ CMS を組みたいので静的サイトだとちょっと具合が悪い</li></ul></li><li>Express + TypeORM で TypeScript な Node.js サーバーを運用</li><li>初期リリースまでは高生産性の恩恵を存分に受ける<ul><li>公開前までは自動マイグレーションで開発</li><li>データモデルは極力 ActiveRecord で実装</li></ul></li></ul></li></ul></section><section class="aligncenter detail"><h2>TypeORM の活用シチュエーション</h2><ul><li>立ち上げ後機能改修を加えていく場合<ul><li>ここからは非 LINE プロジェクトでの体験の話</li><li>直で ActiveRecord を使わずとも Repository に切り替えて queryBuilder も使いつつ運用できることに気づいていく<ul><li>徐々に ActiveRecord による実装が辛くなっていくので移行していく</li><li>もちろん全部ができるわけではないが、割れ窓となりうるコードを排除しつつ前進<ul><li>これまでの ORM ではできなかった戦略のとり方で嬉しい！</li></ul></li></ul></li></ul></li></ul></section><section class="aligncenter"><h2>おわりに</h2></section><section class="aligncenter detail"><h2>おわりに</h2><ul><li>TypeORM はプロダクトと共に成長していける手軽な ORM<ul><li>Rapid Development のための土壌と堅牢な設計のための布石がどちらも揃っている</li><li>はじめから厳格に実装するもよし、あとから切り出すもよしな柔軟な仕様</li><li>決して全ての機能が Simple とは言えないが、 Simple / Easy どちらにも寄せられる</li></ul></li></ul></section><section class="aligncenter detail"><h2>おわりに</h2><ul><li>ORM 好き派嫌い派みたいな概念は必要ない<ul><li>好き嫌いじゃなくているか要らないかで選ぶんだよ</li><li>ORM というざっくりしたものではなくて何が不満で何が便利化を言語化してみる</li></ul></li></ul></section><section class="aligncenter title"><h2>Thank you!</h2><div class="text-fixed-right"><small>Slide generated by <a href="https://github.com/hiroppy/fusuma">hiroppy/fusuma</a></small></div></section></article></div><script type="text/javascript" src="runtime.04040bca95bcb1106035.bundle.js"></script><script type="text/javascript" src="vendor.6.5e1e92922b426fbdb4ed.bundle.js"></script><script type="text/javascript" src="main.3.c06460d473b5566ee112.bundle.js"></script></body></html>